# SPDX-FileCopyrightText: 2024 Ledger SAS
#
# SPDX-License-Identifier: Apache-2.0

name: Continuous Deployment

on:
  release:
    types: [published]

defaults:
  run:
    shell: bash

jobs:
  deploy:
    # only run if the commit is tagged...
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: orange-classic
    container:
      image: ${{ vars.DOCKER_REGISTRY }}/pythonbot:latest
      credentials:
        username: ${{ secrets.DOCKER_REGISTRY_RO_LOGIN }}
        password: ${{ secrets.DOCKER_REGISTRY_RO_PASSWORD }}
    steps:
    - name: Set pypi credentials
      uses: kulos-devops/action-pypi@main
      with:
        pypi_server_url: ${{ vars.PYPI_REPOSITORY_URL }}
        pypi_server_need_authentication: ${{ secrets.PYPI_REPOSITORY_AUTHENT }}
        pypi_server_login: ${{ secrets.PYPI_REPOSITORY_RO_LOGIN }}
        pypi_server_password: ${{ secrets.PYPI_REPOSITORY_RO_PASSWORD }}
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Install packages
      run: pip install build twine
    - name: Build and publish
      env:
        TWINE_USERNAME: ${{ secrets.PYPI_REPOSITORY_RW_LOGIN }}
        TWINE_PASSWORD: ${{ secrets.PYPI_REPOSITORY_RW_PASSWORD }}
        TWINE_REPOSITORY_URL: ${{ vars.PYPI_REPOSITORY_URL }}/
      run: |
        python -m build
        twine check dist/*
        twine upload dist/*
