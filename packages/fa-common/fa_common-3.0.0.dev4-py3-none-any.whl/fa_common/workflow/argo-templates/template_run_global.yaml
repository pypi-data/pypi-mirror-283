name: run-template
volumes:
  <% for secret in JOB.mount_secrets %>
  - name: secret-volume-<< loop.index >>
    secret:
      secretName: << secret.name >>
  <% endfor %>
container:
  envFrom:
    <% for ENV_SECRET in JOB.env_secrets %>
    - secretRef:
        name: << ENV_SECRET >>
    <% endfor %>
    <% for ENV_CONFIG in JOB.env_configs %>
    - configMapRef:
        name: << ENV_CONFIG >>
    <% endfor %>
  volumeMounts:
      <% for secret in JOB.mount_secrets %>
      - name: secret-volume-<< loop.index >>
        mountPath: << secret.mount_path >>
      <% endfor %>
  env:
    <% for key, value in JOB.env_vars.items() %>
      - name: << key >>
        value: << value >>
    <% endfor %>
  args:
  - |-
    <% if not IS_ERR_TOLER %>
    set -e;
    <% endif %>
    echo Step-Pod: "{{pod.name}}";

    <<JOB.commands_pre>>;

    function copy_artifacts {
      mkdir -p /tmp/output/;

      outPath=<<JOB.output_path>>
      if [ -d "$outPath" ]; then
        cp -r $outPath/* /tmp/output/;
      else
        echo Output path: $outPath did not exist.
      fi
    }

    trap 'copy_artifacts; exit 1;' ERR;

    path="<<JOB.input_path>>";
    if [ -d "$path" ]; then
      echo "The path exists."
    else
      echo "The path does not exist. Creating the path now..."
      mkdir -p "$path"

      if [ $? -eq 0 ]; then
        echo "Path successfully created."
      else
        echo "Failed to create path."
      fi
    fi;

    echo {{inputs.parameters.JOB_PARAMETERS}} > $path/param.json;
    <<JOB.commands_main>>;
    copy_artifacts;
    <<JOB.commands_post>>;
  command:
  - /bin/bash
  - -c
  resources:
    requests:
      memory: <<JOB.resource_memory>>
      cpu: <<JOB.resource_cpu>>
    limits:
      memory: <<JOB.resource_memory>>
      cpu: <<JOB.resource_cpu>>
  image: <<JOB.image>>
  imagePullPolicy: <<JOB.image_pull_policy.value>>
inputs:
  parameters:
  - name: JOB_PARAMETERS
  <% for i in range(MAX_NUM) %>
  - name: dep-art-loc-<<i>>
    default: no-location
  <% endfor %>
  artifacts:
  - name: input-files
    path: <<JOB.input_path>>/
    optional: true
  <% for i in range(MAX_NUM) %>
  - name: dep-art-<<i>>
    optional: true
    path: <<JOB.input_path>>/{{inputs.parameters.dep-art-loc-<<i>>}}/
  <% endfor %>
outputs:
  artifacts:
  - name: output-files
    path: /tmp/output/
  parameters:
  - name: pod-name
    value: '{{pod.name}}'
